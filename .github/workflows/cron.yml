name: Scheduled Post Publisher

on:
  schedule:
    # KST Optimized Schedule (Calgary Time MST)
    # Group 1: KST Morning/Lunch (MST 15:00, 16:30, 19:30, 21:00, 23:00)
    - cron: '0 15,21,23 * * *'
    - cron: '30 16,19 * * *'
    
    # Group 2: KST Evening/Night (MST 02:00, 03:30, 05:00, 06:30, 08:00)
    - cron: '0 2,5,8 * * *'
    - cron: '30 3,6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Publish Cron
        run: |
          echo "Calling cron/publish endpoint..."
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "${{ secrets.VERCEL_URL }}/api/cron/publish?secret=${{ secrets.CRON_SECRET }}")
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: API returned non-200 status"
            exit 1
          fi

      - name: Trigger Token Refresh (daily at midnight only)
        if: github.event.schedule == '0 0,3,6,9,12,15,18,21 * * *'
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" = "00" ]; then
            curl -X GET "${{ secrets.VERCEL_URL }}/api/cron/refresh-token?secret=${{ secrets.CRON_SECRET }}"
          fi
