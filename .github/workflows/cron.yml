name: Scheduled Post Publisher

on:
  schedule:
    # 10 posts per day, 90 minutes apart (KST optimal hours)
    # KST = UTC + 9
    - cron: '0 22 * * *'   # 07:00 KST - Morning commute
    - cron: '30 23 * * *'  # 08:30 KST - After arriving
    - cron: '0 1 * * *'    # 10:00 KST - Morning break
    - cron: '30 2 * * *'   # 11:30 KST - Before lunch
    - cron: '0 4 * * *'    # 13:00 KST - After lunch
    - cron: '30 5 * * *'   # 14:30 KST - Afternoon
    - cron: '0 7 * * *'    # 16:00 KST - Afternoon break
    - cron: '30 8 * * *'   # 17:30 KST - Before leaving work
    - cron: '0 10 * * *'   # 19:00 KST - Evening
    - cron: '30 11 * * *'  # 20:30 KST - Golden hour
  workflow_dispatch: # Allow manual trigger

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Publish Cron
        run: |
          echo "Calling cron/publish endpoint..."
          RESPONSE=$(curl -sL -w "\nHTTP_STATUS:%{http_code}" "${{ secrets.VERCEL_URL }}/api/cron/publish?secret=${{ secrets.CRON_SECRET }}")
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: API returned non-200 status"
            exit 1
          fi

      - name: Trigger Token Refresh (daily at midnight KST)
        if: github.event.schedule == '0 15 * * *'
        run: |
          curl -X GET "${{ secrets.VERCEL_URL }}/api/cron/refresh-token?secret=${{ secrets.CRON_SECRET }}"
